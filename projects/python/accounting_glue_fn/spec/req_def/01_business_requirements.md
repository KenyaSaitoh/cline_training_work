# ERP会計統合ETLシステム 要件定義書

## ドキュメント管理

| 項目 | 内容 |
|------|------|
| ドキュメント名 | ERP会計統合ETLシステム 要件定義書 |
| バージョン | 2.0 |
| 作成日 | 2025-10-26 |
| 更新日 | 2025-10-29 |
| ステータス | 承認済み |

### 改訂履歴

| バージョン | 日付 | 内容 |
|-----------|------|------|
| 2.0 | 2025-10-29 | テスト環境、統合出力、業務キー検証の追加 |
| 1.0 | 2025-10-26 | 初版作成 |

---

## 1. システム概要

### 1.1 システムの目的

本システムは、複数の上流業務システム（売上・人事・在庫）から会計ERPパッケージへ、トランザクションデータを自動連携するETL（Extract, Transform, Load）システムである。

業務トランザクションを会計仕訳に変換し、月次決算業務の効率化と正確性向上を実現する。

### 1.2 システムの位置づけ

```
┌─────────────────┐
│  上流システム    │
├─────────────────┤
│ ・売上システム   │───┐
│ ・人事システム   │   │
│ ・在庫システム   │   │
└─────────────────┘   │
                      │
                      ↓
          ┌─────────────────────┐
          │  ETLシステム（本システム）│
          │  ・データ抽出          │
          │  ・データ変換          │
          │  ・データ検証          │
          └─────────────────────┘
                      │
                      ↓
          ┌─────────────────────┐
          │  会計ERPパッケージ      │
          │  ・総勘定元帳          │
          │  ・補助元帳            │
          │  ・財務諸表            │
          └─────────────────────┘
```

### 1.3 対象業務範囲

- 売上トランザクション連携（受注・出荷・請求・入金）
- 人事トランザクション連携（給与・諸手当・控除）
- 在庫トランザクション連携（入庫・出庫・調整・棚卸）

---

## 2. 業務背景と課題

### 2.1 現状の業務課題

#### 課題1: 手作業による仕訳入力の非効率性

**現状**
- 各業務システムからExcelやCSVでデータをダウンロード
- 経理担当者が手作業で会計仕訳を作成・入力
- 月次決算時に約3,000〜5,000件の仕訳を手入力

**問題点**
- 月次決算締めに3〜5営業日を要する
- 入力ミスによる修正作業が頻発
- 経理人員の残業時間増加

#### 課題2: 部門別原価管理の遅延

**現状**
- 人件費・売上原価の部門配賦を月末にまとめて実施
- 配賦計算のための基礎データ収集に時間を要する

**問題点**
- 部門別損益の確定が月次決算後10日以上かかる
- 経営判断のための情報提供が遅い
- 予実管理が後手に回る

#### 課題3: データの不整合とリコンサイル作業

**現状**
- 業務システムと会計システムのデータが一致しないことがある
- 差異原因の調査・修正に多大な工数を要する

**問題点**
- リコンサイル作業に月5〜10人日を投入
- 監査対応の証跡管理が煩雑
- データ品質への信頼性が低い

### 2.2 システム化による効果

| 効果項目 | 定量効果 | 定性効果 |
|---------|---------|---------|
| **業務時間削減** | 月次決算作業：3〜5日 → 1日以内<br>リコンサイル作業：5〜10人日 → 0.5人日 | 経理担当者の負荷軽減<br>残業時間の削減 |
| **正確性向上** | 手入力ミス：月平均30件 → 0件<br>データ不一致：月10件 → 0件 | データ品質の向上<br>監査対応の容易化 |
| **迅速化** | 部門別損益確定：決算後10日 → 翌日<br>仕訳データ入力：月末集中 → 日次取込 | 経営判断の迅速化<br>予実管理の精度向上 |
| **拡張性** | - | 新規システム連携の容易化<br>会計基準変更への対応力向上 |

---

## 3. 業務フロー

### 3.1 売上トランザクション連携業務

#### 3.1.1 業務概要

売上システムで発生する受注・出荷・請求・入金のトランザクションを、会計システムの売上高・売掛金・売上税の仕訳に自動変換する。

#### 3.1.2 業務フロー

```
[売上システム] → [ETL] → [会計システム]
    ↓              ↓          ↓
  受注登録      データ抽出   売上高計上
  出荷確認      変換処理     売掛金計上
  請求書発行    データ検証   消費税計上
  入金記録      仕訳作成     入金消込
```

#### 3.1.3 業務的な意味

**受注（ORDER）**
- **業務**: 顧客からの注文を受け付け、受注伝票を起票
- **会計処理**: 受注時点では会計処理なし（出荷・請求時に計上）
- **管理目的**: 受注残管理、売上予測

**出荷（SHIP）**
- **業務**: 商品を倉庫から出庫し、顧客に発送
- **会計処理**: 収益認識基準が「出荷基準」の場合、売上計上
- **仕訳例**:
  ```
  借方: 売掛金 (1300)     貸方: 売上高 (4100)
  借方: -                貸方: 売上税 (2300)
  ```

**請求（INVOICE）**
- **業務**: 請求書を発行し、顧客に送付
- **会計処理**: 収益認識基準が「検収基準」の場合、売上計上
- **仕訳例**:
  ```
  借方: 売掛金 (1300)     貸方: 売上高 (4100)
  借方: -                貸方: 売上税 (2300)
  ```

**入金（PAYMENT）**
- **業務**: 顧客からの入金を確認、消込処理
- **会計処理**: 売掛金の消込
- **仕訳例**:
  ```
  借方: 現金預金 (1110)   貸方: 売掛金 (1300)
  ```

#### 3.1.4 業務上の特記事項

- **収益認識基準**: 契約ごとに「出荷基準」「検収基準」を使い分け
- **税区分**: 課税売上、輸出免税、非課税の自動判定
- **値引・割引**: キャンペーン値引を自動反映
- **返品処理**: 返品フラグによる逆仕訳の自動生成
- **外貨取引**: 為替レートの自動取得・換算

### 3.2 人事トランザクション連携業務

#### 3.2.1 業務概要

人事システムの従業員組織情報と給与計算結果を基に、給与費用を部門別・コストセンター別に配賦し、会計仕訳を自動作成する。

#### 3.2.2 業務フロー

```
[人事システム] → [ETL] → [会計システム]
    ↓              ↓          ↓
  従業員マスタ   データ抽出   給与費計上
  組織配属情報   部門配賦     部門別費用
  給与計算       手当・控除   預り金計上
  賞与計算       変換処理     未払金計上
```

#### 3.2.3 業務的な意味

**従業員組織情報（EMPLOYEE_ORG）**
- **業務**: 従業員の所属部門、役職、給与グループ等の管理
- **会計処理**: 給与費用の部門配賦マスタとして使用
- **管理目的**: 部門別人件費管理、原価計算

**給与計算（PAYROLL）**
- **業務**: 月次給与の計算（基本給、諸手当、控除）
- **会計処理**: 給与費用と預り金の計上
- **仕訳例**:
  ```
  借方: 給与費 (6100) 500,000円 [部門: 営業部]
  貸方: 給与未払金 (2100) 450,000円
  貸方: 所得税預り金 (2400) 30,000円
  貸方: 社会保険料預り金 (2402) 20,000円
  ```

**複数部門配賦（ALLOCATION）**
- **業務**: プロジェクト兼務者の工数按分
- **会計処理**: 配賦ルールに基づく複数部門への費用分割
- **仕訳例**:
  ```
  借方: 給与費 (6100) 300,000円 [部門: 営業部]
  借方: 給与費 (6100) 200,000円 [部門: 総務部]
  貸方: 給与未払金 (2100) 500,000円
  ```

**賞与（BONUS）**
- **業務**: 年2回の賞与支給
- **会計処理**: 賞与費用の計上
- **仕訳例**:
  ```
  借方: 賞与費 (6110) 1,000,000円 [部門: 営業部]
  貸方: 賞与未払金 (2110) 900,000円
  貸方: 所得税預り金 (2400) 100,000円
  ```

#### 3.2.4 業務上の特記事項

- **配賦ルール**: allocation_rule_codeによる複雑な配賦比率の管理
- **コストセンター**: cost_center_codeによる原価管理
- **給与グループ**: 月給・日給・時給の区分管理
- **課税地域**: 地方税の課税地域別管理
- **プロジェクト連携**: プロジェクト会計への工数連携

### 3.3 在庫トランザクション連携業務

#### 3.3.1 業務概要

在庫システムの入出庫トランザクションを、会計システムの在庫資産・売上原価・仕入債務の仕訳に自動変換する。

#### 3.3.2 業務フロー

```
[在庫システム] → [ETL] → [会計システム]
    ↓              ↓          ↓
  入庫処理       データ抽出   在庫資産計上
  出庫処理       原価計算     売上原価計上
  在庫調整       変換処理     仕入債務計上
  棚卸処理       データ検証   原価差異計上
```

#### 3.3.3 業務的な意味

**入庫（RECEIVE - RCV）**
- **業務**: 仕入先からの商品受け入れ
- **会計処理**: 在庫資産の増加、仕入債務の計上
- **仕訳例**:
  ```
  借方: 在庫資産 (1200) 100,000円
  貸方: 仕入債務 (2200) 100,000円
  ```

**出庫（ISSUE - ISS）**
- **業務**: 販売・製造のための在庫払出し
- **会計処理**: 売上原価の計上、在庫資産の減少
- **仕訳例**:
  ```
  借方: 売上原価 (5100) 80,000円
  貸方: 在庫資産 (1200) 80,000円
  ```

**在庫調整（ADJUSTMENT - ADJ）**
- **業務**: 品質不良、破損等による在庫調整
- **会計処理**: 在庫調整損の計上
- **仕訳例**:
  ```
  借方: 在庫調整損 (5200) 5,000円
  貸方: 在庫資産 (1200) 5,000円
  ```

**棚卸（COUNT - CNT）**
- **業務**: 定期棚卸による実地数量確認
- **会計処理**: 帳簿数量と実地数量の差異計上
- **仕訳例**:
  ```
  借方: 棚卸差異損 (5210) 3,000円
  貸方: 在庫資産 (1200) 3,000円
  ```

**原価差異（COST VARIANCE - CST）**
- **業務**: 標準原価と実際原価の差異
- **会計処理**: 原価差異の計上
- **仕訳例**:
  ```
  借方: 原価差異 (5220) 2,000円
  貸方: 在庫資産 (1200) 2,000円
  ```

#### 3.3.4 業務上の特記事項

- **原価計算方法**: 標準原価、平均原価、FIFO（先入先出）の選択
- **ロット管理**: 製造ロット別の原価管理
- **シリアル管理**: 個体管理が必要な製品の追跡
- **在庫組織**: 複数倉庫・事業所の在庫管理
- **製造連携**: 製造オーダーとの紐付け
- **プロジェクト連携**: プロジェクト別在庫管理

---

## 4. 機能要件

### 4.1 データ抽出機能（Extract）

#### F001: 売上データ抽出

| 項目 | 内容 |
|------|------|
| **機能概要** | 売上システムから売上トランザクションデータを抽出 |
| **抽出対象** | sales_txn_exportテーブル |
| **抽出条件** | バッチIDまたは日付範囲指定 |
| **抽出頻度** | 日次バッチ、随時実行可能 |
| **データ量** | 1日あたり1,000〜5,000件想定 |

#### F002: 人事データ抽出

| 項目 | 内容 |
|------|------|
| **機能概要** | 人事システムから従業員組織データを抽出 |
| **抽出対象** | hr_employee_org_exportテーブル |
| **抽出条件** | 有効期間、バッチID指定 |
| **抽出頻度** | 月次バッチ（給与計算後）、組織改編時 |
| **データ量** | 全社員数500〜2,000名想定 |

#### F003: 在庫データ抽出

| 項目 | 内容 |
|------|------|
| **機能概要** | 在庫システムから在庫移動データを抽出 |
| **抽出対象** | inv_movement_exportテーブル |
| **抽出条件** | 移動タイプ、日付範囲指定 |
| **抽出頻度** | 日次バッチ |
| **データ量** | 1日あたり2,000〜10,000件想定 |

### 4.2 データ変換機能（Transform）

#### F101: 売上仕訳変換

| 項目 | 内容 |
|------|------|
| **機能概要** | 売上トランザクションを会計仕訳に変換 |
| **変換ルール** | - トランザクションタイプ別の勘定科目マッピング<br>- 税区分による消費税仕訳の自動生成<br>- 外貨取引の為替換算<br>- 値引・割引の自動計算<br>- 返品時の逆仕訳生成 |
| **出力形式** | accounting_txn_interface形式 |
| **バリデーション** | 必須項目チェック、金額整合性チェック、借方貸方バランスチェック |

#### F102: 人事仕訳変換

| 項目 | 内容 |
|------|------|
| **機能概要** | 給与データを会計仕訳に変換 |
| **変換ルール** | - 手当種別別の勘定科目マッピング<br>- 部門配賦ルールの適用<br>- 控除項目の預り金仕訳生成<br>- 複数部門への費用按分<br>- コストセンター別集計 |
| **出力形式** | accounting_txn_interface形式 |
| **バリデーション** | 部門マスタ整合性チェック、配賦比率合計100%チェック |

#### F103: 在庫仕訳変換

| 項目 | 内容 |
|------|------|
| **機能概要** | 在庫移動データを会計仕訳に変換 |
| **変換ルール** | - 移動タイプ別の勘定科目マッピング<br>- 原価計算方法の適用<br>- 原価差異の自動計算<br>- ロット別原価管理<br>- プロジェクト連携 |
| **出力形式** | accounting_txn_interface形式 |
| **バリデーション** | 品目マスタ整合性チェック、原価計算チェック |

### 4.3 データ検証機能（Validation）

#### F201: データ品質チェック

| 項目 | 内容 |
|------|------|
| **機能概要** | 抽出・変換データの品質を検証 |
| **チェック項目** | - 必須項目の存在チェック<br>- データ型・範囲チェック<br>- マスタ整合性チェック<br>- 借方貸方バランスチェック<br>- 金額妥当性チェック |
| **エラー処理** | エラーレコードを別テーブルに格納、継続処理可能 |
| **エラー閾値** | 設定可能（デフォルト: エラー率5%まで許容） |

### 4.4 データロード機能（Load）

#### F301: 統合ファイル出力

| 項目 | 内容 |
|------|------|
| **機能概要** | 個別ETL出力を1つの統合CSVファイルに結合 |
| **出力ファイル** | accounting_txn_interface.csv（全システム統合） |
| **処理方式** | merge_etl_outputs.py による自動統合 |
| **重複チェック** | source_system + source_doc_id + source_line_idでの一意性 |

#### F302: 会計インターフェースロード

| 項目 | 内容 |
|------|------|
| **機能概要** | 統合CSVを会計システムの標準インポート機能で取込 |
| **ロード方式** | 会計パッケージの標準CSVインポート |
| **トランザクション** | 会計システム側で制御 |

### 4.5 ジョブ制御機能

#### F401: バッチ実行制御

| 項目 | 内容 |
|------|------|
| **機能概要** | ETLジョブの実行制御と監視 |
| **実行モード** | - 個別システム実行（売上のみ、人事のみ、在庫のみ）<br>- 統合実行（全システム逐次実行）<br>- 並行実行（全システム並列実行） |
| **パラメータ** | バッチID、日付範囲、エラー閾値、リミット件数 |
| **実行履歴** | 実行日時、処理件数、エラー件数、実行時間を記録 |

#### F402: エラーハンドリング

| 項目 | 内容 |
|------|------|
| **機能概要** | エラー発生時の処理制御 |
| **エラー分類** | - データエラー（継続処理可能）<br>- システムエラー（即時停止） |
| **リトライ制御** | システムエラー時の自動リトライ（最大3回） |
| **通知機能** | エラー発生時のメール通知、Slack通知 |

#### F403: ジョブ再開機能

| 項目 | 内容 |
|------|------|
| **機能概要** | 中断したジョブの再開実行 |
| **再開方式** | - バッチID指定での再実行<br>- 未処理データの差分抽出<br>- エラーデータの修正後再投入 |
| **冪等性保証** | 同一データの重複登録防止 |

### 4.6 テスト・検証機能

#### F501: 単体テスト

| 項目 | 内容 |
|------|------|
| **機能概要** | 変換ロジックの単体テスト |
| **テストフレームワーク** | pytest |
| **テスト対象** | Transformerクラス（SalesTransformer, HRTransformer, InventoryTransformer） |
| **テスト内容** | 勘定科目マッピング、金額計算、バリデーション |

#### F502: 統合テスト（出力検証）

| 項目 | 内容 |
|------|------|
| **機能概要** | ETL出力ファイルと期待値データの照合 |
| **検証方式** | 業務キー（source_system/doc_type/doc_id/line_id）による照合 |
| **検証対象** | 期待値データに含まれる代表的レコード（各システム10件程度） |
| **除外フィールド** | batch_id, load_timestamp（実行時変動） |
| **期待値格納** | test_data/expected/*.csv |

#### F503: データ品質レポート

| 項目 | 内容 |
|------|------|
| **機能概要** | データ品質の集計レポートを出力 |
| **レポート内容** | システム別処理件数、エラー種別集計 |
| **出力形式** | ログ出力 |

---

## 5. 非機能要件

### 5.1 性能要件

| 項目 | 要件 |
|------|------|
| **処理時間** | - 売上データ: 1,000件を1秒以内（実績: 0.8秒）<br>- 人事データ: 150件を1秒以内（実績: 0.3秒）<br>- 在庫データ: 1,331件を1秒以内（実績: 0.9秒）<br>- 統合処理: 2,481件を1秒以内（実績: 1.2秒） |
| **同時実行** | 最大3システムの並行実行（Python Native/PySpark選択可） |
| **スループット** | 1,000件/秒以上 |
| **レスポンス** | 即時実行 |

### 5.2 可用性要件

| 項目 | 要件 |
|------|------|
| **稼働時間** | 月〜金 6:00〜23:00（日本時間）<br>※メンテナンス時間を除く |
| **目標稼働率** | 99.5%以上 |
| **リトライ** | 一時的なエラーは自動リトライ（最大3回） |
| **障害復旧** | 障害復旧後の差分データ再処理が可能 |

### 5.3 拡張性要件

| 項目 | 要件 |
|------|------|
| **データ量増加** | 現在の10倍のデータ量まで対応可能な設計 |
| **新規システム追加** | 新規上流システムの追加が容易な設計 |
| **項目追加** | データ項目の追加・変更が容易な設計 |

### 5.4 保守性要件

| 項目 | 要件 |
|------|------|
| **ログ出力** | 処理状況、エラー情報を詳細にログ出力 |
| **ログ保持** | 実行ログを90日間保持 |
| **設定変更** | 勘定科目マッピング等の設定変更が環境変数で可能 |
| **ドキュメント** | 運用手順書、障害対応手順書を整備 |

### 5.5 セキュリティ要件

| 項目 | 要件 |
|------|------|
| **アクセス制御** | AWS IAMによるロールベースアクセス制御 |
| **データ暗号化** | - S3データは暗号化保存（SSE-S3）<br>- データベース接続は暗号化通信（TLS） |
| **監査ログ** | データアクセス履歴をCloudTrailに記録 |
| **個人情報保護** | 人事データ（氏名、口座情報等）の適切な取り扱い |

### 5.6 運用要件

| 項目 | 要件 |
|------|------|
| **バックアップ** | - S3データは自動バックアップ<br>- 処理前データの90日間保持 |
| **監視・通知** | - ジョブ失敗時のメール通知<br>- CloudWatchアラーム設定 |
| **実行スケジュール** | - 売上: 日次 22:00実行<br>- 人事: 月次 25日 23:00実行<br>- 在庫: 日次 23:00実行 |

---

## 6. 制約条件

### 6.1 技術的制約

| 項目 | 制約内容 |
|------|---------|
| **実行環境** | ローカル実行（開発・テスト）、AWS Glue実行（本番） |
| **ETL基盤** | ローカル: Python 3.11、AWS Glue: PySpark |
| **データ処理** | Python Native（ThreadPoolExecutor）またはPySpark（local mode）選択可 |
| **データストア** | CSV入出力ベース（データベース非依存） |

### 6.2 業務的制約

| 項目 | 制約内容 |
|------|---------|
| **処理タイミング** | 上流システムのバッチ処理完了後に実行 |
| **会計期間** | 会計期間確定後のデータ修正は不可（修正仕訳で対応） |
| **承認フロー** | ETL処理は自動実行（承認プロセスなし） |
| **データ保持期間** | 監査対応のため7年間のデータ保持が必要 |

### 6.3 インターフェース制約

| 項目 | 制約内容 |
|------|---------|
| **上流システム** | CSVファイルエクスポート |
| **会計システム** | 統合CSVの標準インポート機能で取込 |
| **データ形式** | - ファイル形式: CSV（ヘッダー行あり）<br>- 文字コード: UTF-8<br>- 日付形式: YYYY-MM-DD<br>- 数値形式: 小数点以下6桁まで |

---

## 7. 用語定義

| 用語 | 定義 |
|------|------|
| **ETL** | Extract（抽出）、Transform（変換）、Load（ロード）の略。データ統合処理の総称 |
| **バッチID** | ETL処理の実行単位を識別する一意のID（例: SALE_20251029_001） |
| **統合ファイル** | 個別システムの出力を1つにまとめたCSVファイル（accounting_txn_interface.csv） |
| **業務キー** | レコードを一意に識別する業務上のキー（source_system/doc_type/doc_id/line_id） |
| **期待値データ** | テスト時に実測値と比較するための正解データ（test_data/expected/*.csv） |
| **勘定科目マッピング** | 業務データの属性から会計勘定科目へ変換するルール |
| **借方貸方バランス** | 複式簿記の原則で、借方合計と貸方合計が一致すること |
| **冪等性** | 同じ処理を複数回実行しても結果が変わらない性質 |
| **配賦** | 費用を複数の部門やプロジェクトに按分すること |
| **収益認識** | IFRS15/ASC606に基づく収益の計上基準 |

---

## 8. 参照ドキュメント

| ドキュメント名 | 参照先 |
|---------------|--------|
| **詳細設計書（売上）** | spec/detail_design/sales_txn_export.md |
| **詳細設計書（人事）** | spec/detail_design/hr_employee_org_export.md |
| **詳細設計書（在庫）** | spec/detail_design/inv_movement_export.md |
| **基本設計書** | spec/basic_design/ |
| **DDL定義書** | ddl/ |
| **運用手順書** | （別途作成） |

---

## 付録A: 業務用語集

### A.1 会計用語

| 用語 | 説明 |
|------|------|
| **総勘定元帳（GL）** | 全ての仕訳を勘定科目別に集計した帳簿 |
| **補助元帳** | 特定の勘定科目の明細を管理する帳簿（得意先元帳、仕入先元帳等） |
| **仕訳** | 取引を借方・貸方の複式で記録したもの |
| **セグメント** | 勘定科目以外の集計軸（部門、製品、プロジェクト等） |
| **期間配分** | 収益や費用を複数期間に配分すること |

### A.2 システム用語

| 用語 | 説明 |
|------|------|
| **トランザクション** | 業務システムで発生する取引データ |
| **マスタデータ** | 得意先、商品、従業員等の基礎データ |
| **リコンサイル** | 2つのシステム間のデータ突合・差異確認作業 |
| **バルクロード** | 大量データを一括で登録する処理方式 |

---

**文書履歴**

| 版数 | 日付 | 変更内容 | 作成者 |
|------|------|---------|--------|
| 1.0 | 2025-10-26 | 初版作成 | ETL開発チーム |

